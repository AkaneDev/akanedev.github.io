<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mystery</title>
  <style>
    :root {
      --bg:#0b0b0d;
      --fg:#ffffff;
      --accent:#00ffd5;
    }
    html,body {
      height:100%;
      margin:0;
      background:linear-gradient(180deg, #000 0%, var(--bg) 100%);
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color:var(--fg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap {
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:24px;
      padding:24px;
      box-sizing:border-box;
    }
    .card {
      text-align:center;
      max-width:900px;
      width:100%;
    }
    .secret {
      font-weight:800;
      font-size:clamp(28px, 9vw, 96px);
      line-height:1;
      letter-spacing: -2px;
      display:inline-block;
      position:relative;
      color:transparent;
      -webkit-text-stroke: 1px rgba(255,255,255,0.06);
      text-transform:uppercase;
      filter:drop-shadow(0 6px 18px rgba(0,0,0,0.7));
    }
    .secret::before {
      content:attr(data-text);
      position:absolute;
      left:0;
      top:0;
      width:100%;
      height:100%;
      color:var(--fg);
      overflow:hidden;
      clip-path: inset(0 100% 0 0);
      transition: clip-path 900ms cubic-bezier(.2,.9,.2,1);
    }
    .secret.jitter {
      animation: jitter 900ms ease-in-out 0s 3 alternate;
    }
    @keyframes jitter {
      0% { transform: translate(0,0) rotate(0); text-shadow: 0 0 0 rgba(0,0,0,0); }
      20% { transform: translate(-8px,2px) rotate(-1deg); text-shadow: -6px 6px 12px rgba(0,0,0,0.6); }
      40% { transform: translate(6px,-2px) rotate(0.5deg); text-shadow: 6px -6px 12px rgba(0,0,0,0.6); }
      60% { transform: translate(-3px,3px) rotate(-0.3deg); text-shadow: -4px 4px 10px rgba(0,0,0,0.6); }
      100% { transform: translate(0,0) rotate(0); text-shadow: 0 0 0 rgba(0,0,0,0); }
    }
    .secret.revealed::before {
      clip-path: inset(0 0 0 0);
      transition: clip-path 420ms cubic-bezier(.2,.9,.2,1);
    }

    .hint {
      color:rgba(255,255,255,0.65);
      font-size:14px;
      margin-top:12px;
    }

    .controls {
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:18px;
    }

    .btn {
      background:transparent;
      border:1px solid rgba(255,255,255,0.12);
      color:var(--fg);
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
    }

    .btn.primary {
      background:var(--accent);
      color:#001;
      border-color:transparent;
      box-shadow:0 6px 18px rgba(0,255,213,0.08);
    }

    #countdown {
      margin-top:12px;
      font-variant-numeric:tabular-nums;
      color:rgba(255,255,255,0.9);
      font-size:18px;
      height:22px;
    }

    /* Overlay that requires a click to start */
    #overlay {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg, rgba(0,0,0,0.85), rgba(0,0,0,0.95));
      z-index:99999;
      color:var(--fg);
      flex-direction:column;
      gap:18px;
      padding:24px;
      box-sizing:border-box;
    }
    #overlay .cta {
      background:transparent;
      border:2px solid rgba(255,255,255,0.12);
      padding:18px 28px;
      border-radius:12px;
      font-size:20px;
      cursor:pointer;
      color:var(--fg);
    }
    #overlay .cta.primary {
      background:var(--accent);
      color:#001;
      border: none;
    }
    #overlay .small {
      color:rgba(255,255,255,0.7);
      font-size:14px;
      max-width:640px;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="wrap" id="main-content" aria-hidden="true">
    <div class="card">
      <div id="title" class="secret" data-text="ONE MORE SECOND...">ONE MORE SECOND...</div>
      <div id="countdown" aria-live="polite"></div>
      <div class="hint">Something is trying to reveal itself... stay put.</div>

      <div class="controls">
        <button id="manual" class="btn">Trigger Now</button>
        <button id="replay" class="btn primary">Replay Reveal</button>
      </div>
    </div>
  </div>

  <div id="overlay" role="dialog" aria-modal="true" aria-label="Click to reveal">
    <div class="small">A secret is about to reveal itself.</div>
    <button id="start-btn" class="cta primary" aria-describedby="start-desc">Click to Reveal</button>
    <div id="start-desc" class="small">Press Enter or Space to activate.</div>
  </div>

  <script src="/script.js"></script>
  <script>
    (function(){
      const title = document.getElementById('title');
      const countdown = document.getElementById('countdown');
      const manual = document.getElementById('manual');
      const replay = document.getElementById('replay');
      const overlay = document.getElementById('overlay');
      const startBtn = document.getElementById('start-btn');
      const mainContent = document.getElementById('main-content');

      // parameters
      const jitterRounds = 3;
      const jitterDuration = 900; // matches CSS jitter duration
      const pauseBeforeReveal = 350; // small pause before reveal animation
      const revealToFlashDelay = 420 + 350; // wait for reveal transition to finish before flashing
      const totalDelay = jitterRounds * jitterDuration + pauseBeforeReveal + revealToFlashDelay;

      let timer = null;

      function startSequence(userGesture = false) {
        // make content accessible now
        mainContent.setAttribute('aria-hidden', 'false');

        // ensure initial classes
        title.classList.remove('revealed');
        // restart jitter by toggling class
        title.classList.remove('jitter');
        void title.offsetWidth;
        title.classList.add('jitter');

        // countdown display loop
        let remaining = Math.ceil(totalDelay/1000);
        countdown.textContent = `Revealing in ${remaining}…`;
        if (timer) clearInterval(timer);
        timer = setInterval(() => {
          remaining = Math.max(0, remaining - 1);
          countdown.textContent = remaining > 0 ? `Revealing in ${remaining}…` : '';
          if (remaining <= 0) { clearInterval(timer); timer = null; }
        }, 1000);

        // schedule reveal
        setTimeout(() => {
          title.classList.remove('jitter');
          title.setAttribute('data-text', 'SECRET');
          title.textContent = 'SECRET';
          void title.offsetWidth;
          title.classList.add('revealed');
        }, jitterRounds * jitterDuration + pauseBeforeReveal);

        // schedule the flashbang to run after reveal transition finishes
        setTimeout(() => {
          const audio = "https://akanedev.au/assets/sfx/flashbang.mp3";
          try {
            flashbang(900, '#ffffff', audio);
          } catch (e) {
            try {
              const a = new Audio(audio);
              // attempt to play only if userGesture is true
              if (userGesture) a.play().catch(()=>{});
            } catch (err) {}
          }
        }, totalDelay + 50);
      }

      // Remove overlay and start when user clicks the CTA
      function activateReveal() {
        overlay.remove();
        // Some browsers will treat the click as user gesture for audio
        startSequence(true);
      }

      startBtn.addEventListener('click', activateReveal);
      // keyboard activation: Enter/Space triggers start
      startBtn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          activateReveal();
        }
      });

      // manual trigger (for users who already activated overlay)
      manual.addEventListener('click', () => {
        try {
          flashbang(900, '#ffffff', "https://akanedev.au/assets/sfx/flashbang.mp3");
        } catch (e) {
          try { new Audio("https://akanedev.au/assets/sfx/flashbang.mp3").play(); } catch(_) {}
        }
      });

      // replay requires a gesture again: show overlay so the browser allows audio
      replay.addEventListener('click', () => {
        // re-show overlay to capture another user gesture
        if (!document.getElementById('overlay')) {
          const ov = document.createElement('div');
          ov.id = 'overlay';
          ov.role = 'dialog';
          ov.setAttribute('aria-modal','true');
          ov.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.85), rgba(0,0,0,0.95));z-index:99999;color:var(--fg);flex-direction:column;gap:18px;padding:24px;box-sizing:border-box;';
          ov.innerHTML = '<div class="small" style="color:rgba(255,255,255,0.7);font-size:14px;max-width:640px;text-align:center;">Click to replay the reveal with sound.</div><button id="overlay-cta" style="padding:18px 28px;border-radius:12px;border:none;background:var(--accent);color:#001;cursor:pointer;">Replay</button>';
          document.body.appendChild(ov);
          document.getElementById('overlay-cta').addEventListener('click', () => {
            ov.remove();
            startSequence(true);
          });
        }
      });

      // Start only after overlay click (do not auto-run)
      // Expose a tiny hint for accessibility to focus the start button
      window.addEventListener('DOMContentLoaded', () => {
        startBtn.focus();
      });
    })();
  </script>
</body>
</html>